extends ../layout

block append css
    link(rel='stylesheet', href='/stylesheets/basket.css')

block content

    div#wishes
        wish-item(v-for="wish in selectedWishes" v-bind:wish="wish")

    a(href='/section')
        button.btn.btn-primary.left(type="button") Revenir aux rayons
           
    a(href='/withdraw')
        button.btn.btn-success.right(type="button") Passer au retrait

block append script
    script.
        //add some usefull fields for vuejs to watch them
        //productsPids(pour l'appel) et productsToMatch(pour la reponse) sont les listes des produits à chercher avec leur pid puis rattacher aux wishes
        //on change le champ product en objet pour qu'il comprenne les productsInfos et l'id
        var wishGroups = JSON.parse('#{ wishGroups }'.replace(/&quot;/g,'"'));
        var pSelectedWishes = JSON.parse('#{ pSelectedWishes }'.replace(/&quot;/g,'"'));var productsToMatch = [];
        var productsPids = [];
        var psw = pSelectedWishes;
        var wgs = wishGroups;
        var wgsLength = wgs.length;
        for(var i = 0; i < wgsLength; i++ ) {
            var wg = wgs[i]; // wishGroup
            var wgLength = wg.wishes?wg.wishes.length:0;
            for(var j = 0; j < wgLength; j++ ) {
                var w = wgs[i].wishes[j]; // wish
                w.product = {id:w.product, infos:{}, quantity : 0};
                w.matchingProducts = [];
                var selected = psw[wg.id]?psw[wg.id][w.id]?true:false:false;
                if( selected && psw[wg.id][w.id].product && psw[wg.id][w.id].product.id) {
                    var productId = psw[wg.id][w.id].product.id;
                    productsToMatchAlreadyExist = productsToMatch.hasOwnProperty(productId);
                    if ( !productsToMatchAlreadyExist ) {
                        productsToMatch[productId] = [{ groupPosition:i, wishPosition:j }];
                    }else{
                        productsToMatch[productId].push({ groupPosition:i, wishPosition:j });
                    }
                    productsPids.push( productId );
                }
            }
        }
        $.ajax({
            type: 'GET',
            url : '/products/details/',
            data: { pids :JSON.stringify(productsPids)},
            complete: function(responseObject) {
                var retreivedProducts = responseObject.responseJSON;
                try {
                    for(var product in productsToMatch) {
                        var infos = retreivedProducts[product];
                        for(var wishIndex in productsToMatch[product]) {
                            var wish = productsToMatch[product][wishIndex];
                            wishGroups[wish.groupPosition].wishes[wish.wishPosition].product.infos = infos;
                        }
                    }
                } catch (e) {
                    console.log('une erreur à la recuperation des details est survenue : ' +e)
                }
            }
        });
    script(src="/javascripts/basket.js")